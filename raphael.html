<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Voronoy diagrams</title>
    <script type="text/javascript" charset="utf-8" src="js/raphael.max.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/ex_path.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/voronoy.js"></script>
    <style type="text/css" media="screen">
      body, body * {
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #000;
      }
    </style>
  </head>
  <body>
    <div id="page">
      <div id="paper"></div>
    </div>
    <script type="text/javascript" charset="utf-8">
      
      (function() {
        document.addEventListener( "DOMContentLoaded", initialize, false );
        window.addEventListener( "resize", redraw, false );
        window.addEventListener( "mousemove", function( e ) {
          last_mouse_pos = { x: e.x, y: e.y };
          sites[ sites.length - 1 ] = last_mouse_pos;
          redraw();
        }, false );
      
        var paper,
            sites,
            bbox,
            voronoi,
            paths,
            last_mouse_pos,
            bg_data,
            closest_center_line;
        
        function initialize() {
          paper = Raphael(
            "paper",
            window.innerWidth,
            window.innerHeight
          );
          
          addPattern( "img/vw.jpg", "template1" );
          addPattern( "img/1.jpg", "template2" );
          addPattern( "img/3.png", "template3" );
          addPattern( "img/ipad_1.png", "template4" );
          addPattern( "img/s4.jpg", "template5" );
          addPattern( "img/w1.jpg", "template6" );
          addPattern( "img/w3.jpg", "template7" );
          
          voronoi = new Voronoi();
          
          paths = [];
          
          last_mouse_pos = { x: paper.width / 2, y: paper.height / 2 };
          bbox = {
        		xl: 0,
        		xr: paper.width,
        		yt: 0,
        		yb: paper.height
        	};
          sites = generateBeeHivePoints( { x: 4.0, y: 3.0 }, true );
          sites.push( last_mouse_pos );
          redraw();
        }
      
        function redraw() {
          draw();
        }
      
        var xlink = "http://www.w3.org/1999/xlink",
        $ = function (el, attr) {
            if (attr) {
                if (typeof el == "string") {
                    el = $(el);
                }
                for (var key in attr) if (attr.hasOwnProperty(key)) {
                    if (key.substring(0, 6) == "xlink:") {
                        el.setAttributeNS(xlink, key.substring(6), String(attr[key]));
                    } else {
                        el.setAttribute(key, String(attr[key]));
                    }
                }
            } else {
                el = Raphael._g.doc.createElementNS("http://www.w3.org/2000/svg", el);
                el.style && (el.style.webkitTapHighlightColor = "rgba(0,0,0,0)");
            }
            return el;
        }
        
        
        function addPattern( img_src, id ) {
          var canvas = paper.canvas,
              doc = canvas.ownerDocument,
              namespaceUri = canvas.namespaceURI,
              defs = paper.defs,
              el = $("pattern"),
              ig = $("image");
              el.id = id;
              $(el, {x: 0, y: 0, patternUnits: "userSpaceOnUse", height: 1, width: 1});
              $(ig, {x: 0, y: 0, "xlink:href": img_src});
              el.appendChild(ig);
          
          (function (el) {
              Raphael._preload(img_src, function () {
                  var w = this.offsetWidth,
                      h = this.offsetHeight;
                  $(el, {width: w, height: h});
                  $(ig, {width: w, height: h});
              });
          })(el);
          
          defs.appendChild( el );
          
          return el.id;
        }
        
        
        function draw() {
          var diagram = voronoi.compute(sites, bbox);
          
        	if (diagram) {
        	  
        	  var current_ids = [],
        	      last_path,
        	      index = 0,
        	      closest_site,
        	      closest_distance;
        	  
        	  if ( undefined !== closest_center_line && null !== closest_center_line ) {
        	    closest_center_line.remove();
        	  }
        	  
        	  for ( ix in paths ) {
        	    current_ids.push( parseInt( ix, 10 ) );
        	  }
        	  
            for ( var i = 0, l = sites.length; i < l; i++ ) {
              var cell = diagram.cells[ sites[i].voronoiId ],
                ix = current_ids.indexOf( sites[i].voronoiId );
              if ( ix !== -1 ) {
                current_ids.splice( ix, 1 );
              }
              
              if ( cell ) {
                var halfedges = cell.halfedges,
                    length = halfedges.length;
                if ( length > 2 ) {
                  var points = [];
                  for (var j = 0; j < length; j++) {
                    v = halfedges[j].getEndpoint();
                    points.push( v );
                  }
                  
                  var fill_template = "",
                      site = sites[ i ];
                  if (
                    site.x > paper._left &&
                    site.x < paper._left + paper.width &&
                    site.y > paper._top &&
                    site.y < paper._top + paper.height
                  ) {
                    fill_template = "template" + ( index++ );
                    if ( last_mouse_pos !== null && i != l - 1 ) {
                      var pointer_distance = Math.pow( last_mouse_pos.x - site.x, 2 ) +
                                             Math.pow( last_mouse_pos.y - site.y, 2 );
                      if ( undefined === closest_distance ||
                            pointer_distance < closest_distance ) {
                        closest_distance = pointer_distance;
                        closest_site = site;
                      }
                    }
                  }
                  
                  paths[ i ] = setPath( points, sites[i], paths[ i ], fill_template );
                }
              }
            }
            
            if (  undefined !== closest_site &&
                  null !== closest_site &&
                  null !== last_mouse_pos ) {
              var ex_connector = new ExPath();
              ex_connector.moveTo( closest_site.x, closest_site.y );
              ex_connector.lineTo( last_mouse_pos.x, last_mouse_pos.y );
              closest_center_line = paper.path( ex_connector.getPathDSL() );
              closest_center_line.attr( { "stroke": "#FFF", "stroke-width": 4 } );
            }
            
            //last_path.attr( "fill", "#000" );
          }
        }

        
        function setPath( points, center, current_path, fill_template ) {
        	
        	if ( points.length <= 2 ) {
        	  return;
        	}
        	
        	var ex_p = new ExPath(),
        	    p1, p2, p3, p12, p23,
        	    points_stack = points;
        	
        	points_stack.push( points[ 0 ] );
        	points_stack.push( points[ 1 ] );
        	
        	while( points_stack.length > 2 ) {
        	  var points_set = [];
        	  p1 = { x: Math.round( points_stack[ 0 ].x ), y: Math.round( points_stack[ 0 ].y ) };
        	  p2 = { x: Math.round( points_stack[ 1 ].x ), y: Math.round( points_stack[ 1 ].y ) };
        	  p3 = { x: Math.round( points_stack[ 2 ].x ), y: Math.round( points_stack[ 2 ].y ) };
        	  p12 = { x: Math.round( ( p1.x + p2.x ) / 2 ), y: Math.round( ( p1.y + p2.y ) / 2 ) };
        	  p23 = { x: Math.round( ( p3.x + p2.x ) / 2 ), y: Math.round( ( p3.y + p2.y ) / 2 ) };
        	  
        	  if ( !ex_p.isStarted() ) {
        	    ex_p.moveTo( p12.x, p12.y );
        	  }
        	  ex_p.sCurveTo( p2.x, p2.y, p23.x, p23.y );
        	  
        	  points_stack = points_stack.slice( 1 );
        	}
        	
          ex_p.close();
          
          var path,
              path_dsl = ex_p.getPathDSL();
          if ( current_path !== undefined && current_path !== null ) {
            path = current_path;
            path.attr( "path", path_dsl );
          } else {
            path = paper.path( path_dsl );
            path.attr( "stroke", "#FFF" );
            path.scale( 0.95 );
            path.attr( "fill", "url(#" + fill_template + ")" );
          }
          
          return path;
        }



        function generateBeeHivePoints( size, loose ) {
        	var points = [];
        	var col = { x: paper.width / size.x, y: paper.height / size.y };
        	for(var i = -1; i < size.x + 1; i++) {
        		for(var j = -1; j < size.y + 1; j++) {
        			var point = {
        			  x: ( i / size.x * paper.width + col.x / 2 ),
        			  y: ( j / size.y * paper.height + col.y / 2 )
        			}
        			if ( j % 2 ) {
        				point.x += col.x / 2;
        			}
        			if ( loose ) {
        				point.x += col.x / 4 * ( Math.random() - 1 );
        				point.y += col.y / 4 * ( Math.random() - 1 );
        			}
        			points.push( point );
        		}
        	}
        	return points;
        }
      })();
    </script>
  </body>
</html>